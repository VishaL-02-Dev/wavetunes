<head>
    <title>Checkout | WaveTunes</title>
    <%- include('./partials/user/header') %>
        <style>
            .checkout-section {
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            .checkout-section:hover {
                transform: scale(1.01);
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            .address-card {
                border: 2px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 1rem;
                margin-bottom: 1rem;
                cursor: pointer;
                transition: border-color 0.2s ease;
            }

            .address-card.selected {
                border-color: #3B82F6;
                background-color: #EFF6FF;
            }

            .address-card:hover {
                border-color: #93C5FD;
            }

            .address-badge {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
                border-radius: 9999px;
                font-weight: 500;
            }

            .badge-default {
                background-color: #10B981;
                color: white;
            }

            .badge-home {
                background-color: #3B82F6;
                color: white;
            }

            .badge-work {
                background-color: #6366F1;
                color: white;
            }

            .badge-other {
                background-color: #8B5CF6;
                color: white;
            }
        </style>
</head>

<body>
    <div class="container mx-auto px-4 py-8">
        <nav class="mb-8" aria-label="Breadcrumb">
            <ol class="flex text-sm">
                <li><a href="/" class="text-white hover:text-blue-700">Home</a></li>
                <li class="mx-2 text-white">/</li>
                <li><a href="/user/cart" class="text-white hover:text-blue-700">My Cart</a></li>
                <li class="mx-2 text-white">/</li>
                <li class="text-white font-medium">Checkout</li>
            </ol>
        </nav>

        <h1 class="text-3xl font-bold mb-8 text-white">Checkout</h1>

        <form id="checkout-form" method="POST" action="/user/placeOrder">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column - Shipping & Payment -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Shipping Information -->
                    <div class="bg-white rounded-lg shadow-md p-6 checkout-section">
                        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Shipping Information</h2>

                        <!-- Saved Addresses Section -->
                        <div class="mb-6">
                            <h3 class="text-lg font-medium mb-4 text-gray-700">Saved Addresses</h3>

                            <!-- Check if user has saved addresses -->
                            <% if (addresses && addresses.length> 0) { %>
                                <div id="saved-addresses">
                                    <% addresses.forEach(function(address) { %>
                                        <div class="address-card <%= address.isDefault ? 'selected' : '' %>"
                                            data-address-id="<%= address._id %>">
                                            <div class="flex justify-between items-start mb-2">
                                                <div class="flex space-x-2">
                                                    <input type="radio" name="addressId" value="<%= address._id %>"
                                                        <%=address.isDefault ? 'checked' : '' %>
                                                    class="mt-1 w-4 h-4 text-blue-600 focus:ring-blue-500">
                                                    <div>
                                                        <div class="flex items-center">
                                                            <span class="font-medium">
                                                                <%= address.addressType %>
                                                            </span>
                                                            <% if (address.isDefault) { %>
                                                                <span
                                                                    class="ml-2 address-badge badge-default">Default</span>
                                                                <% } %>
                                                                    <span
                                                                        class="ml-2 address-badge badge-<%= address.addressType.toLowerCase() %>">
                                                                        <%= address.addressType %>
                                                                    </span>
                                                        </div>
                                                        <p class="text-sm text-gray-600">
                                                            <%= address.address %>
                                                        </p>
                                                        <p class="text-sm text-gray-600">
                                                            <%= address.city %>, <%= address.district %>, <%=
                                                                        address.state %> - <%= address.pinCode %>
                                                        </p>
                                                        <p class="text-sm text-gray-600">Phone: <%= address.phone %>
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <% }); %>
                                </div>
                                <button type="button" id="add-new-address"
                                    class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center mt-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                    Add New Address
                                </button>
                                <% } else { %>
                                    <div class="text-gray-600 mb-4">You don't have any saved addresses yet.</div>
                                    <% } %>
                        </div>

                        <!-- New Address Form (Initially hidden if addresses exist) -->
                        <div id="new-address-form" class="<%= addresses && addresses.length > 0 ? 'hidden' : '' %>">
                            <h3 class="text-lg font-medium mb-4 text-gray-700">Add New Address</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Street
                                        Address</label>
                                    <input type="text" id="address" name="address"
                                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="city" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                                    <input type="text" id="city" name="city"
                                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="district"
                                        class="block text-sm font-medium text-gray-700 mb-1">District</label>
                                    <input type="text" id="district" name="district"
                                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="state"
                                        class="block text-sm font-medium text-gray-700 mb-1">State/Province</label>
                                    <input type="text" id="state" name="state"
                                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="pinCode" class="block text-sm font-medium text-gray-700 mb-1">PIN/Postal
                                        Code</label>
                                    <input type="text" id="pinCode" name="pinCode"
                                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone
                                        Number</label>
                                    <input type="text" id="phone" name="phone"
                                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="addressType"
                                        class="block text-sm font-medium text-gray-700 mb-1">Address Type</label>
                                    <select id="addressType" name="addressType"
                                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="Home">Home</option>
                                        <option value="Work">Work</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="setDefault" name="isDefault"
                                        class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                                    <label for="setDefault" class="ml-2 text-sm text-gray-700">Set as default
                                        address</label>
                                </div>
                            </div>

                            <div class="flex mt-4 space-x-4">
                                <button type="button" id="save-address"
                                    class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition">
                                    Save Address
                                </button>
                                <% if (addresses && addresses.length> 0) { %>
                                    <button type="button" id="cancel-address"
                                        class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md transition">
                                        Cancel
                                    </button>
                                    <% } %>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Information -->
                    <div class="bg-white rounded-lg shadow-md p-6 checkout-section">
                        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Payment Method</h2>
                        <div class="space-y-4">
                            <div class="flex space-x-4 mb-6">
                                <div class="flex items-center">
                                    <input type="radio" id="credit-card" name="paymentMethod" value="creditCard" checked
                                        class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                                    <label for="credit-card" class="ml-2 text-gray-700">Credit Card</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="paypal" name="paymentMethod" value="paypal"
                                        class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                                    <label for="paypal" class="ml-2 text-gray-700">PayPal</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="cod" name="paymentMethod" value="cod"
                                        class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                                    <label for="cod" class="ml-2 text-gray-700">Cash on Delivery</label>
                                </div>
                            </div>

                            <div id="credit-card-form">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="md:col-span-2">
                                        <label for="cardNumber"
                                            class="block text-sm font-medium text-gray-700 mb-1">Card Number</label>
                                        <input type="text" id="cardNumber" name="cardNumber"
                                            placeholder="1234 5678 9012 3456"
                                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label for="cardName" class="block text-sm font-medium text-gray-700 mb-1">Name
                                            on Card</label>
                                        <input type="text" id="cardName" name="cardName"
                                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label for="expiry"
                                                class="block text-sm font-medium text-gray-700 mb-1">Expiry
                                                (MM/YY)</label>
                                            <input type="text" id="expiry" name="expiry" placeholder="MM/YY"
                                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <div>
                                            <label for="cvv"
                                                class="block text-sm font-medium text-gray-700 mb-1">CVV</label>
                                            <input type="text" id="cvv" name="cvv" placeholder="123"
                                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="paypal-form" class="hidden">
                                <p class="text-gray-700">You will be redirected to PayPal to complete your purchase
                                    securely.</p>
                            </div>
                            <div id="cod-form" class="hidden">
                                <p class="text-gray-700">Pay at the time of delivery.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Order Summary -->
                <div>
                    <div class="bg-white rounded-lg shadow-md p-6 sticky top-6 checkout-section">
                        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Order Summary</h2>

                        <div class="space-y-4 mb-4">
                            <% if (cart && cart.items && cart.items.length> 0) { %>
                                <% cart.items.forEach(function(item) { %>
                                    <div class="flex justify-between border-b border-gray-200 pb-2">
                                        <div class="flex items-center">
                                            <span class="text-gray-700 font-medium">
                                                <%= item.quantity %>x
                                            </span>
                                            <span class="ml-2 text-gray-700 truncate max-w-[180px]">
                                                <%= item.product.name %>
                                            </span>
                                        </div>
                                        <span class="font-medium">₹<%= (item.product.price * item.quantity).toFixed(2)
                                                %></span>
                                    </div>
                                    <% }); %>
                                        <% } %>

                                            <div class="space-y-2">
                                                <div class="flex justify-between">
                                                    <span class="text-gray-700">Subtotal</span>
                                                    <span class="font-medium">₹<%= cart.subtotal.toFixed(2) %></span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span class="text-gray-700">Shipping</span>
                                                    <span class="font-medium">₹<%= cart.shipping.toFixed(2) %></span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span class="text-gray-700">Tax</span>
                                                    <span class="font-medium">₹<%= cart.tax.toFixed(2) %></span>
                                                </div>
                                                <hr class="border-gray-200">
                                                <div class="flex justify-between text-xl font-bold">
                                                    <span>Total</span>
                                                    <span>₹<%= cart.total.toFixed(2) %></span>
                                                </div>
                                            </div>
                        </div>

                        <div class="mb-6">
                            <label for="couponCode" class="block text-sm font-medium text-gray-700 mb-1">Coupon
                                Code</label>
                            <div class="flex">
                                <input type="text" id="couponCode" name="couponCode"
                                    class="flex-grow border border-gray-300 rounded-l-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button type="button" id="applyCoupon"
                                    class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-r-md transition">
                                    Apply
                                </button>
                            </div>
                        </div>

                        <button type="submit" id="place-order-btn"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 rounded-md transition">
                            Place Order
                        </button>

                        <div class="mt-4 text-center">
                            <a href="/user/cart" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                Return to Cart
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Toggle payment method forms
            const creditCardRadio = document.getElementById('credit-card');
            const paypalRadio = document.getElementById('paypal');
            const codRadio = document.getElementById('cod');
            const creditCardForm = document.getElementById('credit-card-form');
            const paypalForm = document.getElementById('paypal-form');
            const codForm = document.getElementById('cod-form');

            creditCardRadio.addEventListener('change', function () {
                if (this.checked) {
                    creditCardForm.classList.remove('hidden');
                    codForm.classList.add('hidden');
                    paypalForm.classList.add('hidden');
                }
            });

            paypalRadio.addEventListener('change', function () {
                if (this.checked) {
                    creditCardForm.classList.add('hidden');
                    codForm.classList.add('hidden');
                    paypalForm.classList.remove('hidden');
                }
            });
            codRadio.addEventListener('change', function () {
                if (this.checked) {
                    creditCardForm.classList.add('hidden');
                    paypalForm.classList.add('hidden');
                    codForm.classList.remove('hidden');
                }
            });

            // Address selection
            const addressCards = document.querySelectorAll('.address-card');
            addressCards.forEach(card => {
                card.addEventListener('click', function () {
                    const radioInput = this.querySelector('input[type="radio"]');
                    radioInput.checked = true;

                    // Update visual selection
                    addressCards.forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // Toggle new address form
            const addNewAddressBtn = document.getElementById('add-new-address');
            const newAddressForm = document.getElementById('new-address-form');
            const cancelAddressBtn = document.getElementById('cancel-address');

            if (addNewAddressBtn) {
                addNewAddressBtn.addEventListener('click', function () {
                    newAddressForm.classList.remove('hidden');
                    addNewAddressBtn.classList.add('hidden');
                });
            }

            if (cancelAddressBtn) {
                cancelAddressBtn.addEventListener('click', function () {
                    newAddressForm.classList.add('hidden');
                    addNewAddressBtn.classList.remove('hidden');

                    // Clear form fields
                    const formFields = newAddressForm.querySelectorAll('input, select');
                    formFields.forEach(field => {
                        if (field.type === 'checkbox') {
                            field.checked = false;
                        } else {
                            field.value = '';
                        }
                    });
                });
            }

            // Save new address
            const saveAddressBtn = document.getElementById('save-address');
            if (saveAddressBtn) {
                saveAddressBtn.addEventListener('click', function () {
                    // Basic validation
                    const requiredFields = ['address', 'city', 'district', 'state', 'pinCode', 'phone'];
                    let isValid = true;

                    for (const field of requiredFields) {
                        const input = document.getElementById(field);
                        if (!input.value.trim()) {
                            isValid = false;
                            input.classList.add('border-red-500');
                        } else {
                            input.classList.remove('border-red-500');
                        }
                    }

                    if (!isValid) {
                        Swal.fire({
                            title: 'Error',
                            text: 'Please fill out all required fields for the address',
                            icon: 'error',
                            confirmButtonColor: '#EF4444'
                        });
                        return;
                    }

                    // Prepare data
                    const addressData = {
                        address: document.getElementById('address').value,
                        city: document.getElementById('city').value,
                        district: document.getElementById('district').value,
                        state: document.getElementById('state').value,
                        pinCode: document.getElementById('pinCode').value,
                        phone: document.getElementById('phone').value,
                        type: document.getElementById('addressType').value,
                        isDefault: document.getElementById('setDefault').checked
                    };

                    // Send request to save address
                    fetch('/user/checkout/addAddress', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(addressData),
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire({
                                    title: 'Success!',
                                    text: 'Address saved successfully',
                                    icon: 'success',
                                    confirmButtonColor: '#3B82F6'
                                }).then(() => {
                                    location.reload(); // Reload to show the new address
                                });
                            } else {
                                Swal.fire({
                                    title: 'Error',
                                    text: data.message || 'Failed to save address',
                                    icon: 'error',
                                    confirmButtonColor: '#EF4444'
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire({
                                title: 'Error',
                                text: 'An error occurred. Please try again.',
                                icon: 'error',
                                confirmButtonColor: '#EF4444'
                            });
                        });
                });
            }

            // Handle coupon code application
            document.getElementById('applyCoupon').addEventListener('click', function () {
                const couponCode = document.getElementById('couponCode').value.trim();

                if (!couponCode) {
                    Swal.fire({
                        title: 'Error',
                        text: 'Please enter a coupon code',
                        icon: 'error',
                        confirmButtonColor: '#EF4444'
                    });
                    return;
                }

                fetch('/user/apply-coupon', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        couponCode: couponCode
                    }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: 'Success!',
                                text: data.message || 'Coupon applied successfully!',
                                icon: 'success',
                                confirmButtonColor: '#3B82F6'
                            }).then(() => {
                                location.reload(); // Reload to update prices
                            });
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: data.message || 'Invalid coupon code',
                                icon: 'error',
                                confirmButtonColor: '#EF4444'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'An error occurred. Please try again.',
                            icon: 'error',
                            confirmButtonColor: '#EF4444'
                        });
                    });
            });

            // Form validation before submission
            document.getElementById('checkout-form').addEventListener('submit', function (event) {
                event.preventDefault();

                // Check if an address is selected
                const addressSelected = document.querySelector('input[name="addressId"]:checked');
                if (!addressSelected && document.getElementById('new-address-form').classList.contains('hidden')) {
                    Swal.fire({
                        title: 'Error',
                        text: 'Please select a shipping address',
                        icon: 'error',
                        confirmButtonColor: '#EF4444'
                    });
                    return;
                }

                // If no address is selected and new address form is visible, validate the new address
                if (!addressSelected && !document.getElementById('new-address-form').classList.contains('hidden')) {
                    const requiredFields = ['address', 'city', 'district', 'state', 'pinCode', 'phone'];
                    let isValid = true;

                    for (const field of requiredFields) {
                        const input = document.getElementById(field);
                        if (!input.value.trim()) {
                            isValid = false;
                            input.classList.add('border-red-500');
                        } else {
                            input.classList.remove('border-red-500');
                        }
                    }

                    if (!isValid) {
                        Swal.fire({
                            title: 'Error',
                            text: 'Please fill out all required fields for the address',
                            icon: 'error',
                            confirmButtonColor: '#EF4444'
                        });
                        return;
                    }
                }

                // Credit card validation if that payment method is selected
                if (document.getElementById('credit-card').checked) {
                    const cardFields = ['cardNumber', 'cardName', 'expiry', 'cvv'];
                    let isValid = true;

                    for (const field of cardFields) {
                        const input = document.getElementById(field);
                        if (!input.value.trim()) {
                            isValid = false;
                            input.classList.add('border-red-500');
                        } else {
                            input.classList.remove('border-red-500');
                        }
                    }

                    if (!isValid) {
                        Swal.fire({
                            title: 'Error',
                            text: 'Please fill out all required payment fields',
                            icon: 'error',
                            confirmButtonColor: '#EF4444'
                        });
                        return;
                    }
                }

                // If all validation passes, show loading state and submit
                const submitButton = document.getElementById('place-order-btn');
                submitButton.disabled = true;
                submitButton.innerHTML = 'Processing...';

                Swal.fire({
                    title: 'Confirm Order',
                    text: 'Are you sure you want to place this order?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#10B981',
                    cancelButtonColor: '#EF4444',
                    confirmButtonText: 'Yes, place order!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Show processing message
                        Swal.fire({
                            title: 'Processing Order',
                            text: 'Please wait while we process your order...',
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            showConfirmButton: false,
                            willOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        // Submit the form
                        this.submit();
                    } else {
                        // Re-enable the button if user cancels
                        submitButton.disabled = false;
                        submitButton.innerHTML = 'Place Order';
                    }
                });

            });
        });
    </script>

    <%- include('./partials/user/footer') %>
</body>